version: "3.9"

networks:
  wazuh-net:
    external: true

secrets:
  # Wazuh API user/password for dashboard and manager
  wazuh_api_user:
    external: true
    name: "{{ secret_names.wazuh_api_user }}"
  wazuh_api_password:
    external: true
    name: "{{ secret_names.wazuh_api_password }}"

  # Dashboard TLS
  dashboard_tls_key:
    external: true
    name: "{{ secret_names.dashboard_tls_key }}"
  dashboard_tls_crt:
    external: true
    name: "{{ secret_names.dashboard_tls_crt }}"

services:
  # ---------------- Wazuh Manager ----------------
  wazuh-manager:
    image: "{{ wazuh_image_manager }}"
    networks:
      - wazuh-net
    secrets:
      - source: wazuh_api_user
        target: wazuh_api_user
        mode: 0400
      - source: wazuh_api_password
        target: wazuh_api_password
        mode: 0400
    environment:
      WAZUH_API_USER_FILE: "/run/secrets/wazuh_api_user"
      WAZUH_API_PASSWORD_FILE: "/run/secrets/wazuh_api_password"
      ELASTICSEARCH_HOST: "wazuh-indexer"
      ELASTICSEARCH_PORT: 9200
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.role == worker

  # ---------------- Wazuh Indexer ----------------
  wazuh-indexer:
    image: "{{ wazuh_image_indexer }}"
    networks:
      - wazuh-net
    environment:
      OPENSEARCH_HTTP_SSL_ENABLED: "{{ 'false' }}"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.role == worker

  # ---------------- Wazuh Dashboard ----------------
  wazuh-dashboard:
    image: "{{ wazuh_image_dashboard }}"
    networks:
      - wazuh-net
      - traefik-public
    secrets:
      - source: dashboard_tls_key
        target: dashboard_tls_key
        mode: 0400
      - source: dashboard_tls_crt
        target: dashboard_tls_crt
        mode: 0444
      - source: wazuh_api_user
        target: wazuh_api_user
        mode: 0400
      - source: wazuh_api_password
        target: wazuh_api_password
        mode: 0400
    environment:
      TLS_KEY_FILE: "/run/secrets/dashboard_tls_key"
      TLS_CRT_FILE: "/run/secrets/dashboard_tls_crt"
      WAZUH_API_USER_FILE: "/run/secrets/wazuh_api_user"
      WAZUH_API_PASSWORD_FILE: "/run/secrets/wazuh_api_password"
      ELASTICSEARCH_HOST: "wazuh-indexer"
      ELASTICSEARCH_PORT: 9200
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wazuh-dashboard.rule=Host(`{{ public_ip }}`)"
      - "traefik.http.routers.wazuh-dashboard.entrypoints=websecure"
      - "traefik.http.routers.wazuh-dashboard.tls=true"
      - "traefik.http.routers.wazuh-dashboard.tls.certresolver=selfsigned"
      - "traefik.http.services.wazuh-dashboard.loadbalancer.server.port=5601"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.role == dashboard
