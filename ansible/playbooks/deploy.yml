# deploy.yml
- name: Log in to GitHub Container Registry on Swarm nodes
  hosts: all
  become: true
  tasks:
    - name: Login to GHCR
      docker_login:
        registry_url: ghcr.io
        username: "{{ lookup('env', 'GITHUB_ACTOR') }}"
        password: "{{ lookup('env', 'GHCR_TOKEN') }}"
- name: Deploy Wazuh Stack
  hosts: all
  become: true
  gather_facts: yes
  vars_files:
    - group_vars/all.yml
    - group_vars/vault.yml    # encrypted
  roles:
    - swarm-init    # initializes swarm and joins other nodes
    - networks      # creates overlay networks
    - secrets       # creates Swarm secrets cluster-wide (on dashboard node)
    - traefik       # deploys Traefik reverse proxy with TLS/ACME
    - deploy-stack  # deploys/updates stack with rollback
